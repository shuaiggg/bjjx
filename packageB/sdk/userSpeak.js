var applyTimer,isApplying,isInviting,util=require("./util"),auth=require("./auth"),store=require("./store"),config=require("./config"),command=require("./command"),userData=require("./data/user"),classData=require("./data/class"),eventEmitter=require("./eventEmitter"),toBoolean=require("./function/toBoolean"),$=require("./jquery"),INVITE_REQ_FREE=1,INVITE_REQ_CANCEL=0,INVITE_RES_REJECT=0,INVITE_RES_ACCEPT=1;function stopApplyTimer(){applyTimer&&(clearTimeout(applyTimer),applyTimer=null)}function startApplyTimer(e){stopApplyTimer(),applyTimer=setTimeout(function(){applyTimer=null,eventEmitter.trigger(eventEmitter.SPEAK_APPLY_RESULT_TIMEOUT),exports.cancelApply()},e)}function openSelfMedia(){var e=store.get("user"),t=e.videoOn,i=e.audioOn;t||auth.canOpenCameraWhenSpeaking()&&(t=!0),i||(i=!0),eventEmitter.trigger(eventEmitter.MEDIA_CONTROL_TRIGGER,{audioOn:i,videoOn:t})}var ERROR_FORBID_SPEAK_APPLY=1;function updateSpeakState(e,t,i){var n=function(){eventEmitter.trigger(eventEmitter.MEDIA_SWITCH_TRIGGER,{operator:i,videoOn:e,audioOn:t})};e||t?(store.get("class.speakState")!==config.SPEAK_STATE_FREE&&(store.set("class.speakState",config.SPEAK_STATE_FREE),eventEmitter.trigger(eventEmitter.SPEAK_STATE_CHANGE,{speakState:config.SPEAK_STATE_FREE})),n()):(n(),store.get("class.isFree")||(store.set("class.speakState",config.SPEAK_STATE_LIMIT),eventEmitter.trigger(eventEmitter.SPEAK_STATE_CHANGE,{speakState:config.SPEAK_STATE_LIMIT})))}function processInvite(e){var t=e!==INVITE_RES_REJECT;eventEmitter.trigger(eventEmitter.SPEAK_INVITE_RES_TRIGGER,{confirm:e,accept:t}),t&&openSelfMedia()}exports.ERROR_FORBID_SPEAK_APPLY=ERROR_FORBID_SPEAK_APPLY,exports.startApply=function(e){if(!isApplying){if(!isInviting)return isApplying=!0,startApplyTimer(e),eventEmitter.trigger(eventEmitter.SPEAK_APPLY_REQ_TRIGGER),!0;exports.processInvite(!0)}},exports.cancelApply=function(){if(isApplying)return isApplying=!1,stopApplyTimer(),exports.processApply(store.get("user.id"),!1),!0},exports.processApply=function(e,t){var i=userData.find(e);if(i)return eventEmitter.trigger(eventEmitter.SPEAK_APPLY_RES_TRIGGER,{accept:t,user:i,speakState:t?config.SPEAK_STATE_FREE:config.SPEAK_STATE_LIMIT}),!0},exports.isApplying=function(e){return 0<=getApplying(e)},exports.stopSpeak=function(){var e=store.get("user");if(e)return eventEmitter.trigger(eventEmitter.MEDIA_REMOTE_CONTROL_TRIGGER,{user:e,videoOn:!1,audioOn:!1,speakState:config.SPEAK_STATE_LIMIT}),!0},exports.processInvite=function(e){if(isInviting)return isInviting=!1,processInvite(e?INVITE_RES_ACCEPT:INVITE_RES_REJECT),!0},exports.isInviting=function(e){return 0<=getInviting(e)},exports.init=function(e){isApplying=isInviting=!1,eventEmitter.on(eventEmitter.UPDATE_SPEAK_STATE,function(e,t){updateSpeakState(t.videoOn,t.audioOn,t.operator)}).on(eventEmitter.CLASS_END,function(){isApplying&&exports.cancelApply()}).on(eventEmitter.MEDIA_CONTROL_TRIGGER,function(e,t){updateSpeakState(toBoolean(t.videoOn),toBoolean(t.audioOn))}).on(eventEmitter.MEDIA_SWITCH_TRIGGER,function(e,t){var i=t.operator,n=store.get("user");i&&i.id!==n.id&&(t.videoOn||t.audioOn)&&eventEmitter.trigger(eventEmitter.SPEAK_INVITE_RES_TRIGGER,{accept:!0,force:!0})}).on(eventEmitter.SPEAK_APPLY_RES,function(e,t){var i=t.user.id;if(auth.isSelf(i)){var n=t.speakState;if(auth.isSelf(t.fromId))eventEmitter.trigger(eventEmitter.SPEAK_APPLY_RESULT_CANCEL);else{if(!isApplying)return;isApplying=!1,stopApplyTimer();t={operator:userData.find(t.fromId)};n===config.SPEAK_STATE_FREE?(eventEmitter.trigger(eventEmitter.SPEAK_APPLY_RESULT_ACCEPT,t),openSelfMedia()):eventEmitter.trigger(eventEmitter.SPEAK_APPLY_RESULT_REJECT,t)}}}).on(eventEmitter.SPEAK_STOP_TRIGGER,function(){store.get("user");exports.stopSpeak()}).on(eventEmitter.SPEAK_START_TRIGGER,function(e,t){exports.startApply(t.timeout)}).on(eventEmitter.SPEAK_CANCEL_TRIGGER,function(e,t){exports.cancelApply()}).on(eventEmitter.SPEAK_INVITE_REQ,function(e,t){if(auth.canPushStream())switch(t.invite){case INVITE_REQ_FREE:isInviting||(isApplying?(exports.cancelApply(),processInvite(INVITE_RES_ACCEPT)):(isInviting=!0,eventEmitter.trigger(eventEmitter.SPEAK_INVITE_CONFIRM)));break;case INVITE_REQ_CANCEL:isInviting&&(isInviting=!1,eventEmitter.trigger(eventEmitter.SPEAK_INVITE_RESULT_CANCEL))}})};