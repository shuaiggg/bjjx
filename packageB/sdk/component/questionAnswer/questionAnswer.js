var $=require("../../jquery"),store=require("../../store"),config=require("../../config"),roomServer=require("../../server/room"),eventEmitter=require("../../eventEmitter"),info=require("../../info"),language=require("./language/main")(),FiniteArray=require("../../function/FiniteArray"),camelCaseObject=require("../../function/camelCaseObject");$.extend(roomServer.messageTypes,require("./signaling")),$.extend(eventEmitter,require("./eventEmitter"));var timestampArray,scrollTop,scrollBottom,touchStartY,QuestionType={ALL:15,PUBLISHED:1,NOT_PUBLISHED:2,ANSWERED:4,NOT_ANSWERED:8},isFetching=!1,scrollListHeight=-1;Component({properties:{countPerPage:{type:Number,value:15},inputMaxLength:{type:Number,value:140},limitPerMinute:{type:Number,value:10}},data:{questionList:[],language:language,isForbidden:!1,selfNumber:"",inputValue:"",inputLength:0,scrollTop:0,countSelfPage:0,pageTotal:1,pageCurrent:1},ready:function(){var s=this,u=s.data,l={};timestampArray=new FiniteArray(u.limitPerMinute),eventEmitter.on(eventEmitter.QUESTION_PULL_REQ,function(e,t){isFetching||(roomServer.send({message_type:"question_pull_req",page:t.page,count_per_page:u.countPerPage,status:QuestionType.PUBLISHED,number:l.number}),isFetching=!0)}).on(eventEmitter.QUESTION_PULL_RES,function(e,t){var n=Math.ceil(t.categoryCounts.pub/u.countPerPage)||1;s.setData({pageTotal:n>t.selfPageCount?n:t.selfPageCount,countSelfPage:t.selfPageCount,pageCurrent:t.page+1,questionList:t.list,isForbidden:t.forbidStatus}),s.resortList(),isFetching=!1}).on(eventEmitter.QUESTION_SEND_REQ,function(e,t){var n={message_type:"question_send_req",from:{id:l.id,number:l.number,type:l.type,name:l.name,avatar:l.avatar,end_type:l.endType},content:t.content};roomServer.send(n)}).on(eventEmitter.QUESTION_SEND_RES,function(e,t){var n=u.questionList;if(1===u.pageCurrent){var r={status:t.status,id:t.id,forbid:!1,itemList:[{time:t.time,content:t.content,from:t.from}]};n.unshift(r),n.length>u.countPerPage&&n.pop(),s.setData({questionList:n}),setTimeout(function(){s.setData({scrollTop:0})},200),info.tip(language.INFO_QUESTION_SEND_SUCCESS)}var i=Math.ceil(t.categoryCounts.pub/u.countPerPage)||1;s.setData({countSelfPage:t.selfPageCount,pageTotal:i>t.selfPageCount?i:t.selfPageCount})}).on(eventEmitter.QUESTION_PUB,function(e,n){var r=-1,t=n.status,i=u.questionList;if($.each(i,function(e,t){if(t.id===n.id)return r=e,!1}),-1<r){var a=i[r];t&QuestionType.NOT_PUBLISHED?n.owner!==l.number&&i.splice(r,1):a.itemList=n.content,a.status=n.status,s.setData({questionList:i})}else 1===u.pageCurrent&&i.length<u.countPerPage&&(i.push({status:n.status,id:n.id,forbid:!1,itemList:n.content}),s.setData({questionList:i}),s.resortList());var o=Math.ceil(n.categoryCounts.pub/u.countPerPage)||1;s.setData({pageTotal:o>u.countSelfPage?o:u.countSelfPage})}).on(eventEmitter.QUESTION_SWITCH_FORBID_RES,function(e,t){t.to.number===l.number&&s.setData({isForbidden:t.switch})}).on(eventEmitter.CLASSROOM_CONNECT_SUCCESS,function(){l=store.get("user"),s.setData({selfNumber:l.number}),eventEmitter.trigger(eventEmitter.QUESTION_PULL_REQ,{page:0})})},methods:{onInput:function(e){this.setData({inputLength:e.detail.value.length})},onTouchStart:function(e){touchStartY=e.changedTouches[0].clientY},onTouchCancel:function(e){touchStartY=null},onTouchEnd:function(e){var t,n=this.data,r=e.changedTouches[0].clientY-touchStartY;touchStartY&&120<Math.abs(r)&&(scrollBottom<50&&r<0&&n.pageCurrent<n.pageTotal&&(t=n.pageCurrent+1),scrollTop<50&&0<r&&1<n.pageCurrent&&(t=n.pageCurrent-1),t&&eventEmitter.trigger(eventEmitter.QUESTION_PULL_REQ,{page:t-1}))},onScroll:function(e){var t=e.detail;scrollListHeight<0&&wx.createSelectorQuery().in(this).select(".scroll-list").boundingClientRect(function(e){scrollListHeight=e.height}).exec(),scrollTop=t.scrollTop,scrollBottom=t.scrollHeight-t.scrollTop-scrollListHeight},sendQuestion:function(e){var t=this.data,n=$.trim(e.detail.value);n&&(n.length<=t.inputMaxLength?timestampArray.isFull()&&+new Date-timestampArray.getFirst()<config.MINUTE?info.alert(language.ERROR_TOO_FREQUENT):(eventEmitter.trigger(eventEmitter.QUESTION_SEND_REQ,{content:n}),timestampArray.push(+new Date),this.setData({inputValue:"",inputLength:0})):info.alert(language.ERROR_TOO_LONG))},resortList:function(){var e=this.data.questionList;e.sort(function(e,t){return t.id-e.id}),this.setData({questionList:e})}}});