define(function(require,exports,module){"use strict";BJY.data.doc;var s,n,i,a,p,g,o,c,r,u,l,f,d,h,m=BJY.eventEmitter,v=require("./loading"),e=require("cc/util/instance"),C=BJY.os;function P(){"hidden"===p.css("visibility")&&(p.addClass("bjy-active"),setTimeout(function(){p&&p.addClass("bjy-visible")}))}function E(e){p&&p[0].contentWindow.postMessage(JSON.stringify(e),"*")}function _(){c&&(clearTimeout(c),c=null)}function A(e,t){if(p&&r&&u){var n=e/r,i=t/u,a=Math.min(n,i);return e=Math.floor(r*a),t=Math.floor(u*a),C.ios||C.android||E({name:"setScale",scale:a}),p.prop({width:e,height:t}),!0}}function T(e,t,n){g=!1,p=$('<iframe src="'+BJY.adjustProtocol(e)+'" frameborder="0" scrolling="no" width="'+l+'" height="'+f+'"></iframe>');var i,a,o,r=s.find("img");1===r.length?p.insertAfter(r):s.prepend(p),_(),i=e,a=t,o=n,c=setTimeout(function(){c=null,p&&(p.remove(),setTimeout(function(){T(i,a,o)},100))},1e5)}e.window.on("message",function(e){if(!n)try{var t=JSON.parse(e.originalEvent.data);switch(t.name){case"ready":if(g)return A(l,f),void(0<d||0<h?(o=!0,E({name:"goto",page:d,step:h})):(P(),v.hide()));g=!0,_(),a=t.page,r=t.width,u=t.height,A(l,f),m.trigger(m.PPT_READY,{url:p.prop("src"),page:a,pageCount:t.pageCount,step:t.step,stepCount:t.stepCount,targetPage:d,targetStep:h}),a===d&&t.step===h||E({name:"goto",page:d,step:h});break;case"pagechange":t.page===d&&a!==t.page&&(a=t.page,m.trigger(m.PPT_PAGE_CHANGE,{url:i,page:a,stepCount:t.stepCount}));break;case"stepchange":t.step===h&&(o?(P(),v.hide()):m.trigger(m.PPT_STEP_CHANGE,{url:i,step:t.step}))}}catch(e){}}),exports.init=function(e){s=e,m.on(m.PAGE_CHANGE_END,function(){p&&!n&&P()}).on(m.WHITEBOARD_DOM_CHANGE,function(){p&&(p.remove(),T(i,d,h),v.show())})},exports.setPage=function(e,t,n){return o=!1,d=e.pptPage,h=e.pptStep,i!==e.pptUrl?(exports.remove(),i=e.pptUrl,l=t,f=n,T(i,d,h),{page:e.page,pptUrl:i}):p?(c||E({name:"goto",page:d,step:h}),{page:e.page,pptUrl:i,hasCache:!0,isStepChange:d===a}):void 0},exports.enable=function(){n=!1},exports.disable=function(){n=!0,_(),g||exports.remove()},exports.remove=function(){p&&(p.remove(),p=i=null),_()},exports.resize=function(e,t){A(l=e,f=t)&&m.trigger(m.PPT_SIZE_CHANGE)}});