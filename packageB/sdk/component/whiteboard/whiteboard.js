var loadedImageUrl,removeDoc,pageChangeData,auth=require("../../auth"),store=require("../../store"),config=require("../../config"),docData=require("../../data/doc"),pageData=require("../../data/page"),eventEmitter=require("../../eventEmitter"),$=require("../../jquery"),loading=require("./loading"),getDocumentImageDimension=require("../../function/getDocumentImageDimension"),toNumber=require("../../function/toNumber"),getMainAreaDimension=require("../../function/getMainAreaDimension"),language=require("../../language/main")(),pageInfo={},touchTime=0,touchDot=0,touchInterval="",systemInfo=wx.getSystemInfoSync();function requestAll(){eventEmitter.trigger(eventEmitter.DOC_ALL_REQ)}var pageEnd=function(e){eventEmitter.trigger(eventEmitter.PAGE_CHANGE_END,pageInfo)},changePage=function(e,t){var a=docData.getComplexPage(e);eventEmitter.trigger(eventEmitter.PAGE_CHANGE_TRIGGER,{docId:a.docId,page:a.page,step:t})};Component({properties:{canUsePptSelection:{type:Boolean,value:!0},canDraw:{type:Boolean,value:!0},showClear:{type:Boolean,value:!0},hidePageCount:{type:Boolean,value:!0,observer:function(e,t){0==pageInfo.page?this.setData({showPageCount:!0}):this.setData({showPageCount:!e})}},drawing:{type:Boolean,value:!1},size:{type:Object,value:{width:systemInfo.windowWidth,height:Math.ceil(3*systemInfo.windowWidth/4)},observer:function(e,t){e&&t&&eventEmitter.trigger(eventEmitter.WHITEBOARD_RESIZE)}},styleInfo:{type:"Object",value:{backgroundColor:"black",pageCountColor:"white",pageCountBackground:"#C2C0C1"}}},data:{pageInfo:{},language:language,pageCount:"",finished:!1,showPageCount:!1,currentPage:0,showPptSelection:!1,showNext:!1,showPrev:!1},ready:function(){var i=this;function e(e,t){var n=t.docId,o=t.page,a=docData.getDocumentById(n);a&&($.extend(pageInfo,a.pageList[o]),i.getImageDimension(pageInfo.width,pageInfo.height,function(e){var t=docData.getSimplePage(n,o).page;pageInfo.docId=n,pageInfo.docPage=o,pageInfo.page=t,pageInfo.rawWidth=+pageInfo.width,pageInfo.rawHeight=+pageInfo.height,docData.getQuality(),loadedImageUrl=null,(pageChangeData=pageInfo).hasPrevPage=pageData.hasPrevPage(t),pageInfo.hasNextPage=pageData.hasNextPage(t),pageInfo.width=e.width,pageInfo.height=e.height;var a={pageInfo:pageInfo,pageCount:"  "+(pageInfo.page?pageInfo.page+"/"+docData.getDocumentCount():language.WHITE_BOARD)+"  "};a.showPageCount=!i.data.hidePageCount||0==pageInfo.page,i.setData(a),eventEmitter.trigger(eventEmitter.PAGE_CHANGE_START,pageInfo)}))}$.extend(config,require("./config")),$.extend(eventEmitter,require("./eventEmitter")),eventEmitter.on(eventEmitter.PAGE_PREV_TRIGGER,function(){auth.canPage()&&pageData.prevPage()&&changePage(pageData.getClientPage())}).on(eventEmitter.PAGE_NEXT_TRIGGER,function(){auth.canPage()&&pageData.nextPage()&&changePage(pageData.getClientPage())}),loading.init(),eventEmitter.on(eventEmitter.SERVER_PAGE_CHANGE,e).on(eventEmitter.WHITEBOARD_DRAWING_CHANGE,function(e,t){i.setData({drawing:t.drawing})}).on(eventEmitter.CLIENT_PAGE_CHANGE,e).on(eventEmitter.CURRENT_PAGE_SHAPE_LOAD_END,pageEnd).on(eventEmitter.CURRENT_DOC_IMAGE_LOAD_SUCCESS,function(e,t){var a=t.rawUrl;i.setData({finished:!0}),a!==loadedImageUrl&&(loadedImageUrl=a,pageEnd())}).on(eventEmitter.DOC_QUALITY_CHANGE_TRIGGER,function(e,t){var a=toNumber(t.value);a!==docData.getQuality()&&(t.value=a,docData.setQuality(a),exports.refresh(),eventEmitter.trigger(eventEmitter.DOC_QUALITY_CHANGE,t))}).on(eventEmitter.WHITEBOARD_RESIZE,function(e,t){i.resize()}).on(eventEmitter.ROOM_SERVER_LOGIN_SUCCESS,requestAll)},methods:{onPageCountTap:function(){var e=this;console.log("onPageCountTap");e.data.showPptSelection;e.data.canUsePptSelection&&e.setData({showPptSelection:!0})},getImageDimension:function(e,t,a){wx.createSelectorQuery();var n=this.data;a(getDocumentImageDimension(n.size.width,n.size.height,e,t,docData.getFit(),!0,1),pageInfo)},resize:function(){var t=this;console.log("whiteboard resize"),t.getImageDimension(pageInfo.rawWidth,pageInfo.rawHeight,function(e){pageInfo.width=e.width,pageInfo.height=e.height,t.setData({pageInfo:pageInfo})})},touchStart:function(e){console.log("touchStart");this.data.drawing||(console.log(2),touchDot=e.touches[0].pageX,touchInterval=setInterval(function(){touchTime++},100))},showNext:function(){var e=this;e.setData({showNext:!0}),setTimeout(function(){e.setData({showNext:!1})},500)},showPrev:function(){var e=this;e.setData({showPrev:!0}),setTimeout(function(){e.setData({showPrev:!1})},500)},touchEnd:function(e){console.log("touch end");var t=this;if(!t.data.drawing){console.log(2);var a=e.changedTouches[0].pageX;a-touchDot<=-config.TOUCH_DISTANCE&&touchTime<config.TOUCH_TIME&&(t.showNext(),console.log(3),eventEmitter.trigger(eventEmitter.PAGE_NEXT_TRIGGER)),a-touchDot>=config.TOUCH_DISTANCE&&touchTime<config.TOUCH_TIME&&(t.showPrev(),eventEmitter.trigger(eventEmitter.PAGE_PREV_TRIGGER)),clearInterval(touchInterval),touchTime=0}},onWhiteboardTap:function(){this.data;console.log("onWhiteboardTap"),this.triggerEvent("whiteboardTap")},onClearTap:function(e){eventEmitter.trigger(eventEmitter.CLEAR_CANVAS)},onPptImageTap:function(e){var t=e.detail.item,a=docData.getComplexPage(t.page);eventEmitter.trigger(eventEmitter.CLIENT_PAGE_CHANGE,{docId:a.docId,page:a.page})}}});