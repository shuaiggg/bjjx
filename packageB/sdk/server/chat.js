"use strict";var Timer=require("../Timer"),store=require("../store"),config=require("../config"),eventEmitter=require("../eventEmitter"),serverData=require("../data/server"),camelCaseObject=require("../function/camelCaseObject"),WebSocket=require("./WebSocket"),$=require("../jquery"),getWebSocketUrl=require("../function/getWebSocketUrl"),messageTypes={login_res:function(e){chatServer.startHeartbeat(),0===e.code?eventEmitter.trigger(eventEmitter.CHAT_SERVER_LOGIN_SUCCESS,{messageList:camelCaseObject(e.message_list)}):eventEmitter.trigger(eventEmitter.CHAT_SERVER_LOGIN_FAIL)},message_receive:function(e){var t=camelCaseObject(e.from);eventEmitter.trigger(eventEmitter.MESSAGE_RECEIVE,{id:e.id,time:e.time,content:e.content,channel:e.channel,data:e.data,from:{id:t.id,number:t.number,name:t.name,type:t.type,status:t.status,endType:t.endType,avatar:t.avatar}})},message_whisper_receive:function(e){var t=camelCaseObject(e.from);eventEmitter.trigger(eventEmitter.MESSAGE_RECEIVE,{time:e.time,content:e.content,data:e.data,to:e.to,from:{id:t.id,number:t.number,name:t.name,type:t.type,status:t.status,endType:t.endType,avatar:t.avatar}})},message_pull_res:function(e){eventEmitter.trigger(eventEmitter.MESSAGE_PULL_RES,{next:e.next,channel:e.channel,hasMore:!!e.has_more,messageList:camelCaseObject(e.message_list)})}},chatServer={messageTypes:messageTypes,init:function(){chatServer.socket;chatServer.socket=new WebSocket({interval:config.SECOND,retryCount:config.WEBSOCKET_TRY_CONNECT_COUNT,timeout:config.CHAT_SERVER_CONNECT_TIMEOUT,onSend:function(e){eventEmitter.trigger(eventEmitter.WEBSOCKET_SEND,e)},onReceive:function(e){var t=messageTypes[e.message_type];t&&t(e),eventEmitter.trigger(eventEmitter.WEBSOCKET_RECEIVE,e)},onOpen:function(e){var t=e.server;$.extend(chatServer,t),serverData.setActiveChatServer(t),eventEmitter.trigger(eventEmitter.CHAT_SERVER_CONNECT_SUCCESS,e),chatServer.login()},onClose:function(){chatServer.endHeartbeat(),eventEmitter.trigger(eventEmitter.WEBSOCKET_CLOSE,this),eventEmitter.trigger(eventEmitter.CHAT_SERVER_OFFLINE)},onError:function(){eventEmitter.trigger(eventEmitter.CHAT_SERVER_CONNECT_FAIL)},onTimeout:function(){eventEmitter.trigger(eventEmitter.CHAT_SERVER_CONNECT_FAIL)}});var e=serverData.getChatServerList()[0];e.url=getWebSocketUrl(e),chatServer.connect(e,serverData.getChatProxyServerList()),chatServer.heartbeatTimer=new Timer({task:function(){chatServer.heartbeat()},interval:config.HEARTBEAT_INTERVAL})},connect:function(e,t){var r=chatServer.socket;r&&r.connect(e,t)},login:function(){var e=chatServer.socket,t=store.get("user");e.send({message_type:"login_req",class_id:store.get("class.id"),user:{id:t.id,number:t.number,group:store.get("user.group",0),type:t.type,name:t.name,actual_name:t.actualName,avatar:t.avatar,status:t.status,end_type:t.endType}})},startHeartbeat:function(){chatServer.endHeartbeat(),chatServer.heartbeatTimer.start()},endHeartbeat:function(){chatServer.heartbeatTimer.stop()},heartbeat:function(){chatServer.send({message_type:"heart_beat"})},send:function(e){var t=chatServer.socket;t&&t.send(e)},close:function(){console.log("chat server close by program");var e=chatServer.socket,t=$.Deferred();return e?e.close().then(function(){t.resolve(),chatServer.socket=null}):t.resolve(),t}};module.exports=chatServer;