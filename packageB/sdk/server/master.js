var toBoolean=require("../function/toBoolean"),store=require("../store"),config=require("../config"),eventEmitter=require("../eventEmitter"),camelCaseObject=require("../function/camelCaseObject"),underScoreCaseObject=require("../function/underScoreCaseObject"),userData=require("../data/user"),serverData=require("../data/server"),liveServer=require("../server/live"),WebSocket=require("./WebSocket"),getWebSocketUrl=require("../function/getWebSocketUrl"),$=require("../jquery"),messageTypes={server_info_res:function(e){var r;masterServer.serverInfo=e,serverData.addRoomServer(e.room_server),serverData.addChatServer(e.chat_server),serverData.addLiveServer(camelCaseObject(e.cdn_domain)),liveServer.setActiveUplinkServer(e.cdn_domain[1].push),(r=store.get("user")).publishServer={ip:liveServer.getActiveUplinkServer(),port:1935},r.publishIndex=0,serverData.setUdpUplinkServerList(e.uplink_server_list),serverData.setUdpDownlinkServerList(e.downlink_server_list),serverData.setRoomProxyServerList(camelCaseObject(e.proxy_room_server_list)),serverData.setChatProxyServerList(camelCaseObject(e.proxy_chat_server_list)),serverData.setActiveMasterServer({ip:masterServer.ip,port:masterServer.port}),(r=store.get("user")).id&&userData.remove(r.id);var t={stable:e.stable,base:e.base,live:camelCaseObject(e.config),"user.id":e.id,"user.id2":""+(+e.id+1),"user.id3":""+(+e.id+2),"user.ip":e.user_ip};store.set(t),eventEmitter.trigger(eventEmitter.SERVER_INFO_FETCH_SUCCESS)}},masterServer={messageTypes:messageTypes,init:function(){masterServer.serverInfo=null;var n=masterServer.socket=new WebSocket({interval:config.SECOND,retryCount:config.WEBSOCKET_TRY_CONNECT_COUNT,timeout:config.MASTER_SERVER_CONNECT_TIMEOUT,onSend:function(e){eventEmitter.trigger(eventEmitter.WEBSOCKET_SEND,e)},onReceive:function(e){var r=messageTypes[e.message_type];r&&r(e),eventEmitter.trigger(eventEmitter.WEBSOCKET_RECEIVE,e)},onOpen:function(e){$.extend(masterServer,e.server),eventEmitter.trigger(eventEmitter.MASTER_SERVER_CONNECT_SUCCESS,e);var r=store.get("class"),t=r.enrolledStudents,s=r.freeOfCharge,i={message_type:"server_info_req",class_id:store.get("class.id"),class_type:store.get("class.type"),link_capability:store.get("class.linkCapability")||0,teacher_number:store.get("teacher.number"),user_type:store.get("user.type"),live_chat_mode:store.get("partner.liveChatMode"),client_ip:store.get("user.clientIp"),end_type:store.get("user.endType"),enrolled_students:"number"===$.type(t)?t:0,free_of_charge:toBoolean(s),udp_foreign_proxy:store.get("partner.liveUdpForeignProxy",0),tcp_foreign_proxy:store.get("partner.liveTcpForeignProxy",0),ms_config:underScoreCaseObject(store.get("partner.msConfig"))};masterServer.send(i),setTimeout(function(){masterServer.serverInfo||(n.close(),eventEmitter.trigger(eventEmitter.SERVER_INFO_FETCH_FAIL))},config.SERVER_INFO_FETCH_TIMEOUT)},onClose:function(){eventEmitter.trigger(eventEmitter.WEBSOCKET_CLOSE,this)},onError:function(){eventEmitter.trigger(eventEmitter.MASTER_SERVER_CONNECT_FAIL)},onTimeout:function(){eventEmitter.trigger(eventEmitter.MASTER_SERVER_CONNECT_TIMEOUT)}}),e=store.get("partner.ms");e.url=getWebSocketUrl(e),masterServer.connect(e,serverData.getMasterProxyServerList())},connect:function(e,r){var t=masterServer.socket;t&&t.connect(e,r)},send:function(e){var r=masterServer.socket;r&&r.send(e)},close:function(){console.log("master server close by program");var e=masterServer.socket,r=$.Deferred();return e?e.close().then(function(){r.resolve(),masterServer.socket=null}):r.resolve(),r}};module.exports=masterServer;