var store=require("../store"),config=require("../config"),eventEmitter=require("../eventEmitter"),$=require("../jquery"),classData=require("./class"),idToUserMap={},numberToUserMap={};function isValidUserId(e){return e||0===e}function getValidUser(e){var r=idToUserMap[e];if(r&&r===numberToUserMap[r.number])return r}function updateUser(e){var r=e.type===config.ROLE_TYPE_TEACHER,t=e.id===store.get("user.id"),i={};r&&$.extend(i,store.get("teacher")),t&&$.extend(i,store.get("user")),$.extend(i,e),r&&store.set("teacher",i),t&&store.set("user",i);var n=store.get("presenterId");return n?e.id===n&&store.set("presenter",i):r&&(store.set("presenterId",i.id),store.set("presenter",i)),i}function diff(e,t){var i=[];return $.each(e,function(e,r){$.isArray(r)||$.isPlainObject(r)?(null==t[e]||0<diff(r,t[e]).length)&&i.push(e):r!==t[e]&&i.push(e)}),i}exports.add=function(e,r){$.isArray(e)||(e=[e]);var s=[];$.each(e,function(e,r){if(r){var t=r.id,i=r.number;if(isValidUserId(t)){if(getValidUser(t))return void exports.update(r);if(0!=i){var n=numberToUserMap[r.number];n&&isValidUserId(n.id)&&exports.remove(n.id)}r=updateUser(r),idToUserMap[t]=numberToUserMap[i]=r,s.push(r)}}});var t=exports.group(s),i=t.teacherList;1===i.length&&(store.set("teacher",i[0]),eventEmitter.trigger(eventEmitter.TEACHER_ADD,{userList:i}));var n=t.assistantList;0<n.length&&eventEmitter.trigger(eventEmitter.ASSISTANT_ADD,{userList:n});var a=t.studentList;0<a.length&&eventEmitter.trigger(eventEmitter.STUDENT_ADD,{userList:a}),0<s.length&&eventEmitter.trigger(eventEmitter.USER_ADD,{userList:s})},exports.remove=function(e){var r=getValidUser(e);if(r){var t;switch(r.videoOn=r.audioOn=null,r.type){case config.ROLE_TYPE_TEACHER:t=eventEmitter.TEACHER_REMOVE;break;case config.ROLE_TYPE_ASSISTANT:t=eventEmitter.ASSISTANT_REMOVE;break;case config.ROLE_TYPE_STUDENT:t=eventEmitter.STUDENT_REMOVE;break;case config.ROLE_TYPE_GUEST:t=eventEmitter.GUEST_REMOVE}return delete idToUserMap[e],delete numberToUserMap[r.number],eventEmitter.trigger(t,{user:r}),eventEmitter.trigger(eventEmitter.USER_REMOVE,{user:r}),!0}return!1},exports.update=function(t){var e=getValidUser(t.id);if(null!=e){var r=diff(t,e);if(0===r.length)return;var i={};$.each(r,function(e,r){i[r]=t[r]});var n,s=updateUser(t);switch(idToUserMap[t.id]=numberToUserMap[t.number]=s,t.type){case config.ROLE_TYPE_TEACHER:n=eventEmitter.TEACHER_UPDATE;break;case config.ROLE_TYPE_ASSISTANT:n=eventEmitter.ASSISTANT_UPDATE;break;case config.ROLE_TYPE_STUDENT:n=eventEmitter.STUDENT_UPDATE;break;case config.ROLE_TYPE_GUEST:n=eventEmitter.GUEST_UPDATE}var a={user:s,update:i};return eventEmitter.trigger(n,a),eventEmitter.trigger(eventEmitter.USER_UPDATE,a),s}numberToUserMap[t.number]||exports.add(t)},exports.find=function(e){return getValidUser(e)},exports.findByNumber=function(e){var r=numberToUserMap[e];return r&&getValidUser(r.id)},exports.active=function(){return exports.all().filter(function(e){return!(!e.videoOn&&!e.audioOn)})},exports.all=function(){var t=[];return $.each(idToUserMap,function(e){var r=getValidUser(e);r&&t.push(r)}),t},exports.isAudioSpeex=function(e){return e.endType==config.END_TYPE_PC_BROWSER||classData.isAudioSpeex()},exports.group=function(e){var t=[],i=[],n=[];return $.each(e||idToUserMap,function(e,r){switch(r.type){case config.ROLE_TYPE_TEACHER:t.push(r);break;case config.ROLE_TYPE_ASSISTANT:i.push(r);break;case config.ROLE_TYPE_STUDENT:n.push(r)}}),{teacherList:t,assistantList:i,studentList:n}};