!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Canvas=e()}(this,function(){"use strict";var w={each:function(t,e,i){var n=t.length;if(n)if(i)for(var o=n-1;0<=o&&!1!==e(t[o],o);o--);else for(var r=0;r<n&&!1!==e(t[r],r);r++);},push:function(t,e){t.push(e)},pop:function(t){t.pop()},remove:function(t,e){var i=t.indexOf(e);if(0<=i)return t.splice(i,1),!0},last:function(t){return t[t.length-1]},has:function(t,e){return 0<=t.indexOf(e)}},_=function(t,e){if(!(t instanceof e))throw new Error("Cannot call a class as a function")},o=function(t,e){if("function"!=typeof e&&null!==e)throw new Error("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},d=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e};function e(e,i){w.each(Object.keys(e),function(t){return i(e[t],t)})}var h={each:e,copy:function i(t,n){var o=t;return Array.isArray(t)?(o=[],w.each(t,function(t,e){o[e]=n?i(t,n):t})):t&&"object"==typeof t&&(o={},e(t,function(t,e){o[e]=n?i(t,n):t})),o},extend:function(i,t){return t&&e(t,function(t,e){i[e]=t}),i}},t=function(){function i(t,e){_(this,i),h.extend(this,t),this.emitter=e,this.state=!0}return i.prototype.on=function(t,e){return this.emitter.on(t,e,!0),this},i.prototype.off=function(t,e){return this.emitter.off(t,e),this},i.prototype.destroy=function(){},i.prototype.draw=function(){},i}(),i=wx.getSystemInfoSync().pixelRatio,A={DEVICE_PIXEL_RATIO:i,STROKE_POSITION_INSIDE:1,STROKE_POSITION_CENTER:2,STROKE_POSITION_OUTSIDE:3,SIZE_MIN:6*i},O=function(){function x(){_(this,x);var e,i,n,o,r,s,h,a,p=this,u={},t={};p.listeners={};var f=function(t){r=t.pageX,s=t.pageY,e=r-u.x,i=s-u.y,container&&(e+=container.scrollLeft,i+=container.scrollTop),n=e*A.DEVICE_PIXEL_RATIO,o=i*A.DEVICE_PIXEL_RATIO},c=function(t){var e=t.touches;f(e?e[0]:t)},l=function(t,e){a&&p.fire(t,e)};u.x=u.y=t.x=t.y=0;var y=function(t){if(!p.disabled&&!t.button){if(a)return void d();c(t),l(x.MOUSE_DOWN,{x:n,y:o,realX:e,realY:i,pageX:r,pageY:s,target:t.target,inCanvas:h})}},d=function(){p.disabled||(l(x.MOUSE_UP,{x:n,y:o,realX:e,realY:i,pageX:r,pageY:s,inCanvas:h}),a&&(a=!1))},E="undefined"!=typeof document?document:null;if(E){var S={},v=function(t,e){E&&(E.addEventListener(t,e),S[t]=e)};v("mousedown",y),v("mousemove",function(t){p.disabled||(f(t),l(x.MOUSE_MOVE,{x:n,y:o,realX:e,realY:i,pageX:r,pageY:s,inCanvas:!!a||h}))}),v("mouseup",d),"ontouchstart"in E&&(v("touchstart",y),v("touchmove",function(t){p.disabled||(c(t),l(x.MOUSE_MOVE,{x:n,y:o,realX:e,realY:i,pageX:r,pageY:s,inCanvas:!!a||h}))}),v("touchend",d)),g&&v("keyup",function(t){if(!p.disabled){var e=g[t.keyCode];e&&p.fire(e)}}),this.documentEvents=S,this.canvasEvents={}}}return x.prototype.fire=function(t,e){var i=this.listeners[t];i&&w.each(i,function(t){if(t)return t(e)})},x.prototype.on=function(t,e,i){var n=this.listeners[t]||(this.listeners[t]=[]);return i?n.unshift(e):n.push(e),this},x.prototype.off=function(t,e){var i=this.listeners[t];return i&&w.remove(i,e),this},x.prototype.dispose=function(){},x}();O.RESET="reset",O.CLEAR="clear",O.MOUSE_DOWN="mouse_down",O.MOUSE_MOVE="mouse_move",O.MOUSE_UP="mouse_up",O.SHAPE_ENTER="shape_enter",O.SHAPE_LEAVE="shape_leave",O.HOVER_SHAPE_CHANGE="hover_shape_change",O.ACTIVE_SHAPE_CHANGE="active_shape_change",O.ACTIVE_SHAPE_DELETE="active_shape_delete",O.ACTIVE_SHAPE_ENTER="active_shape_enter",O.ACTIVE_RECT_CHANGE_START="active_rect_change_start",O.ACTIVE_RECT_CHANGE_END="active_rect_change_end",O.ACTIVE_DRAG_BOX_HOVER="active_drag_box_hover",O.SELECTION_RECT_CHANGE="selection_rect_change",O.SELECTION_START="selection_start",O.SELECTION_END="selection_end",O.SHAPE_DRAWING_START="shape_drawing_start",O.SHAPE_DRAWING="shape_drawing",O.SHAPE_DRAWING_END="shape_drawing_end",O.SHAPE_ADD="shape_add",O.SHAPE_REMOVE="shape_remove",O.SHAPE_UPDATE="shape_update";var g={8:O.ACTIVE_SHAPE_DELETE,13:O.ACTIVE_SHAPE_ENTER,36:O.CLEAR,46:O.ACTIVE_SHAPE_DELETE};function E(i,n,o){return function(t,e){n<t?(i.x=n,i.width=t-n):(i.x=t,i.width=n-t),o<e?(i.y=o,i.height=e-o):(i.y=e,i.height=o-e)}}var a=function(i){function n(t,o){_(this,n);var r,e=d(this,i.call(this,t,o)),s=e;return s.mouseDownHandler=function(t){if(!r&&t.inCanvas){var e=E(s,t.x,t.y);o.fire(O.SELECTION_START);var i=function(t){e(t.x,t.y),o.fire(O.SELECTION_RECT_CHANGE,{rect:s})},n=function(){o.off(O.MOUSE_MOVE,i),o.off(O.MOUSE_UP,n),o.off(O.RESET,n),s.x=s.y=s.width=s.height=e=null,o.fire(O.SELECTION_END)};o.on(O.MOUSE_MOVE,i).on(O.MOUSE_UP,n).on(O.RESET,n)}},s.shapeEnterHandler=function(t){r=t.shape},s.shapeLeaveHandler=function(){r&&(r=null)},s.on(O.MOUSE_DOWN,s.mouseDownHandler).on(O.SHAPE_ENTER,s.shapeEnterHandler).on(O.SHAPE_LEAVE,s.shapeLeaveHandler),e}return o(n,i),n.prototype.destroy=function(){this.off(O.MOUSE_DOWN,this.mouseDownHandler).off(O.SHAPE_ENTER,this.shapeEnterHandler).off(O.SHAPE_LEAVE,this.shapeLeaveHandler)},n.prototype.isPointInPath=function(t,e,i){return!1},n.prototype.draw=function(t){var e=this.x,i=this.y,n=this.width,o=this.height;n&&o&&(t.disableShadow(),t.setLineWidth(1),t.setStrokeStyle("#ccc"),t.setFillStyle("rgba(180,180,180,0.1)"),t.begin(),t.drawRect(e+.5,i+.5,n,o),t.stroke(),t.fill())},n}(t);function x(t){return!!t.toJSON().fontSize}var u=function(i){function r(t,n,h){_(this,r);var a,p,u,f,c,o,e=d(this,i.call(this,t,n)),l=e;l.shapes=[];var y=function(){o=l.shapes.map(function(t){return t.save(l)})};return l.clearHandler=function(){l.setShapes(h,[])},l.shapeEnterHandler=function(t){var e=t.shape;e.state||(c=e)},l.shapeLeaveHandler=function(){c&&(c=null)},l.mouseDownHandler=function(t){if(0<=a){var e=l.x,i=l.y,n=e+l.width,o=i+l.height;switch(a){case 0:f=E(l,n,o);break;case 1:p=e,f=E(l,n,o);break;case 2:f=E(l,e,o);break;case 3:u=o,f=E(l,e,i);break;case 4:f=E(l,e,i);break;case 5:p=n,f=E(l,e,i);break;case 6:f=E(l,n,i);break;case 7:u=o,f=E(l,n,i)}y()}else if(c){w.has(l.shapes,c)||l.setShapes(h,[c]);var r=t.x-l.x,s=t.y-l.y;f=function(t,e){l.x=t-r,l.y=e-s},y()}else t.inCanvas&&l.shapes.length&&l.setShapes(h,[])},l.mouseMoveHandler=function(t){if(f)return f(p||t.x,u||t.y),n.fire(O.ACTIVE_RECT_CHANGE_START),w.each(l.shapes,function(t,e){t.restore(l,o[e])}),void n.fire(O.ACTIVE_RECT_CHANGE_END);var e,i=l.isPointInPath(h,t.x,t.y);if(!1!==i){if(a!==i)switch(a=i){case 1:case 5:e="ns";break;case 3:case 7:e="ew";break;case 0:case 4:e="nwse";break;case 2:case 6:e="nesw"}}else 0<=a&&(e="",a=-1);null!=e&&n.fire(O.ACTIVE_DRAG_BOX_HOVER,{name:e})},l.mouseUpHandler=function(t){0<=a&&(a=-1,n.fire(O.ACTIVE_DRAG_BOX_HOVER,{name:""})),f=p=u=null},l.resetUpHandler=function(t){0<=a&&l.mouseUpHandler(t),l.setShapes(h,[])},l.on(O.CLEAR,l.clearHandler).on(O.SHAPE_ENTER,l.shapeEnterHandler).on(O.SHAPE_LEAVE,l.shapeLeaveHandler).on(O.MOUSE_DOWN,l.mouseDownHandler).on(O.MOUSE_MOVE,l.mouseMoveHandler).on(O.MOUSE_UP,l.mouseUpHandler).on(O.RESET,l.resetUpHandler),e}return o(r,i),r.prototype.destroy=function(){this.off(O.CLEAR,this.clearHandler).off(O.SHAPE_ENTER,this.shapeEnterHandler).off(O.SHAPE_LEAVE,this.shapeLeaveHandler).off(O.MOUSE_DOWN,this.mouseDownHandler).off(O.MOUSE_MOVE,this.mouseMoveHandler).off(O.MOUSE_UP,this.mouseUpHandler).off(O.RESET,this.resetUpHandler)},r.prototype.getShapes=function(){return this.shapes},r.prototype.setShapes=function(e,t){if(0<t.length){var i=function(t){var e=t.length;if(!e)throw new Error("getUnionRect rects array length have to be large than 1.");for(var i=t[0],n=i.x,o=i.y,r=n+i.width,s=o+i.height,h=1;h<e;h++)(i=t[h]).x<n&&(n=i.x),i.y<o&&(o=i.y),i.x+i.width>r&&(r=i.x+i.width),i.y+i.height>s&&(s=i.y+i.height);return{x:n,y:o,width:r-n,height:s-o}}(t.map(function(t){return t.getRect(e)}));h.extend(this,i)}else this.width=this.height=0;this.shapes=t,this.emitter.fire(O.ACTIVE_SHAPE_CHANGE,{shapes:t})},r.prototype.isPointInPath=function(t,e,i){var n=this.boxes,o=this.thumbSize;if(n)for(var r,s,h=0,a=n.length;h<a;h+=2)if(r=n[h],s=n[h+1],r-o<=e&&e<=r+2*o&&s-o<=i&&i<=s+2*o)return h/2;return!1},r.prototype.draw=function(i){var n,t=this.shapes,e=this.x,o=this.y,r=this.width,s=this.height,h=t.length;if(h&&(i.disableShadow(),i.setLineWidth(1),1<h?(n=!0,i.setStrokeStyle("#C0CED8"),w.each(t,function(t){var e=t.getRect(i);i.strokeRect(e.x+.5,e.y+.5,e.width,e.height),n&&!x(t)&&(n=!1)})):n=x(t[0]),i.setStrokeStyle("#ccc"),i.begin(),i.drawRect(e+.5,o+.5,r,s),i.stroke(),!n)){i.setStrokeStyle("#a2a2a2"),i.enableShadow(0,2,3,"rgba(0,0,0,0.2)");for(var a,p=this.thumbSize=6*A.DEVICE_PIXEL_RATIO,u=e-p/2,f=e+(r-p)/2,c=e+r-p/2,l=o-p/2,y=o+(s-p)/2,d=o+s-p/2,E=[u,l,f,l,c,l,c,y,c,d,f,d,u,d,u,y],S=0,v=E.length;S<v;S+=2)e=E[S],o=E[S+1],(a=i.createLinearGradient(e,o+p,e,o)).addColorStop(0,"#d6d6d6"),a.addColorStop(1,"#f9f9f9"),i.begin(),i.setFillStyle(a),i.drawRect(e,o,p,p),i.stroke(),i.fill();this.boxes=E,i.disableShadow()}},r}(t),f=function(s){function h(t,i){_(this,h);var n,o,e=d(this,s.call(this,t,i)),r=e;return r.shapeEnterHandler=function(t){var e=t.shape;o||e.state||n&&w.has(n,e)||(r.shape=e,i.fire(O.HOVER_SHAPE_CHANGE,{shape:e}))},r.shapeLeaveHandler=function(){r.shape&&(r.shape=null,i.fire(O.HOVER_SHAPE_CHANGE,{shape:null}))},r.drawingStartHandler=function(){o=!0},r.drawingEndHandler=function(){o=!1},r.activeShapeChangeHandler=function(t){n=t.shapes,w.has(n,r.shape)&&(r.shape=null)},r.resetHandler=function(){r.shape=null},r.on(O.SHAPE_ENTER,r.shapeEnterHandler).on(O.SHAPE_LEAVE,r.shapeLeaveHandler).on(O.SHAPE_DRAWING_START,r.drawingStartHandler).on(O.SHAPE_DRAWING_END,r.drawingEndHandler).on(O.ACTIVE_SHAPE_CHANGE,r.activeShapeChangeHandler).on(O.RESET,r.resetHandler),e}return o(h,s),h.prototype.destroy=function(){this.off(O.SHAPE_ENTER,this.shapeEnterHandler).off(O.SHAPE_LEAVE,this.shapeLeaveHandler).off(O.SHAPE_DRAWING_START,this.drawingStartHandler).off(O.SHAPE_DRAWING_END,this.drawingEndHandler).off(O.ACTIVE_SHAPE_CHANGE,this.activeShapeChangeHandler).off(O.RESET,this.resetHandler)},h.prototype.isPointInPath=function(t,e,i){return!1},h.prototype.draw=function(t){var e=this.shape,i=this.hoverThickness,n=this.hoverColor;e&&(t.disableShadow(),t.setLineWidth(i*A.DEVICE_PIXEL_RATIO),t.setStrokeStyle(n),t.begin(),e.drawPath(t),t.stroke())},h}(t),c=function(f){function c(t,e,i){_(this,c);var n,o,r,s,h,a=d(this,f.call(this,t,e)),p=a,u=function(){r?i.restore(r):r=i.save()};return p.mouseDownHandler=function(t){t.inCanvas&&(o=0,s=Math.floor(t.x),h=Math.floor(t.y),(n=new p.createShape).startDrawing&&!1===n.startDrawing(i,e,t)?n=null:e.fire(O.SHAPE_DRAWING_START,{cursor:"crosshair"}))},p.mouseMoveHandler=function(t){n&&n.drawing&&(o++,n.drawing(i,s,h,Math.floor(t.x),Math.floor(t.y),u))},p.mouseUpHandler=function(){if(r&&(r=null),n){if(n.endDrawing)return void n.endDrawing();e.fire(O.SHAPE_DRAWING_END,{shape:0<o?n:null}),n=null}},p.on(O.MOUSE_DOWN,p.mouseDownHandler).on(O.MOUSE_MOVE,p.mouseMoveHandler).on(O.MOUSE_UP,p.mouseUpHandler).on(O.RESET,p.mouseUpHandler),a}return o(c,f),c.prototype.destroy=function(){this.off(O.MOUSE_DOWN,this.mouseDownHandler).off(O.MOUSE_MOVE,this.mouseMoveHandler).off(O.MOUSE_UP,this.mouseUpHandler).off(O.RESET,this.mouseUpHandler)},c.prototype.isPointInPath=function(t,e,i){return!1},c}(t);function s(t,e,i,n,o){var r=n/e,s=o/i;1===r&&1===s||w.each(t,function(t){1!==r&&(t.x&&(t.x*=r),t.width&&(t.width*=r),t.fontSize&&(t.computeFontSize||(t.computeFontSize=t.fontSize),t.computeFontSize=t.computeFontSize*r,t.computeFontSize<1.5?t.fontSize=1.5:t.fontSize=t.computeFontSize)),1!==s&&(t.y&&(t.y*=s),t.height&&(t.height*=s)),t.points&&w.each(t.points,function(t){t.x&&(t.x*=r),t.y&&(t.y*=s)})})}var l=function(){function n(t,e,i){_(this,n),this.context=t,this.width=e,this.height=i}return n.prototype.getCanvasSize=function(){return{width:this.width,height:this.height}},n.prototype.begin=function(){this.context.beginPath()},n.prototype.close=function(){this.context.closePath()},n.prototype.drawRect=function(t,e,i,n){this.context.rect(t,e,i,n)},n.prototype.drawOval=function(t,e,i,n){var o=this.context;if(i===n){var r=i/2;o.moveTo(t+r,e),o.arc(t,e,r,0,2*Math.PI,!0)}else{var s=this.context;if(i===n){var h=i/2;s.moveTo(t+h,e),s.arc(t,e,h,0,2*Math.PI,!0)}else{var a=i/.75/2,p=n/2,u=[{x:t,y:e-p},{x:t+a,y:e-p},{x:t+a,y:e+p},{x:t,y:e+p},{x:t-a,y:e+p},{x:t-a,y:e-p}];s.moveTo(u[0].x,u[0].y),s.bezierCurveTo(u[1].x,u[1].y,u[2].x,u[2].y,u[3].x,u[3].y),s.bezierCurveTo(u[4].x,u[4].y,u[5].x,u[5].y,u[0].x,u[0].y)}var f=i/.75/2,c=n/2;s.moveTo(t,e-c),s.bezierCurveTo(t+f,e-c,t+f,e+c,t,e+c),s.bezierCurveTo(t-f,e+c,t-f,e-c,t,e-c)}},n.prototype.drawPoints=function(t){var e=t.length;if(1<e){var i=t[0];this.moveTo(i.x,i.y);for(var n=1;n<e;n++)i=t[n],this.lineTo(i.x,i.y)}},n.prototype.stroke=function(){this.context.stroke()},n.prototype.draw=function(t){this.context.draw(t)},n.prototype.fill=function(){this.context.fill()},n.prototype.strokeRect=function(t,e,i,n){this.context.strokeRect(t,e,i,n)},n.prototype.fillRect=function(t,e,i,n){this.context.fillRect(t,e,i,n)},n.prototype.strokeText=function(t,e,i){this.context.strokeText(i,t,e)},n.prototype.fillText=function(t,e,i){this.context.fillText(i,t,e)},n.prototype.measureText=function(t){return this.context.measureText(t)},n.prototype.isPointInPath=function(t,e){return this.context.isPointInPath(t,e)},n.prototype.clear=function(){this.context.draw()},n.prototype.moveTo=function(t,e){this.context.moveTo(t,e)},n.prototype.lineTo=function(t,e){this.context.lineTo(t,e)},n.prototype.arc=function(t,e,i,n,o,r){this.context.arc(t,e,i,n,o,r)},n.prototype.bezierCurveTo=function(t,e,i,n,o,r){this.context.bezierCurveTo(t,e,i,n,o,r)},n.prototype.createLinearGradient=function(t,e,i,n){return this.context.createLinearGradient(t,e,i,n)},n.prototype.enableShadow=function(t,e,i,n){return this.context.setShadow(t,e,i,n)},n.prototype.disableShadow=function(){},n.prototype.save=function(){var t=this.context,e=t.canvas,i=e.width,n=e.height;if(t.getImageData&&0<i&&0<n)return t.getImageData(0,0,i,n)},n.prototype.restore=function(t){var e=this.context;e.putImageData&&t&&e.putImageData(t,0,0)},n.prototype.setFont=function(t,e,i,n){this.context.setFontSize(t)},n.prototype.setLineWidth=function(t){this.context.setLineWidth(t)},n.prototype.setLineJoin=function(t){this.context.setLineJoin(t)},n.prototype.setLineCap=function(t){this.context.setLineCap(t)},n.prototype.setStrokeStyle=function(t){this.context.setStrokeStyle(t)},n.prototype.setFillStyle=function(t){this.context.setFillStyle(t)},n}();function p(t,e,i,n,o,r,s){if(!o)return!1;var h=o/2;if(t+h<r&&i+h<r||r<t-h&&r<i-h||e+h<s&&n+h<s||s<e-h&&s<n-h)return!1;if(t===i)return Math.abs(r-t)<=h;var a=(n-e)/(i-t),p=(t*n-i*e)/(t-i);return Math.pow(a*r-s+p,2)/(a*a+1)<=Math.pow(h,2)}function r(t,e,i){return e>=t.x&&e<=t.x+t.width&&i>=t.y&&i<=t.y+t.height}function y(t){return t&&"transparent"!==t}var n=function(){function e(t){_(this,e),h.extend(this,t)}return e.prototype.isPointInPath=function(t,e,i){var n=this.getRect(t);return n.width||(n.x-=A.SIZE_MIN/2,n.width=A.SIZE_MIN),n.height||(n.y-=A.SIZE_MIN/2,n.height=A.SIZE_MIN),!!r(n,e,i)&&(y(this.fillStyle)&&this.isPointInFill?this.isPointInFill(t,e,i):this.isPointInStroke(t,e,i))},e.prototype.isPointInStroke=function(t,e,i){var n=this.lineWidth,o=this.points;n<A.SIZE_MIN&&(n=A.SIZE_MIN);for(var r=0,s=o.length;r<s;r++)if(o[r+1]&&p(o[r].x,o[r].y,o[r+1].x,o[r+1].y,n*A.DEVICE_PIXEL_RATIO,e,i))return!0;return!1},e.prototype.draw=function(t){var e=this.fill&&y(this.fillStyle),i=this.lineWidth&&y(this.strokeStyle);(e||i)&&(e&&(i||this.applyShadow(t),this.fill(t)),i&&(this.applyShadow(t),this.setLineStyle(t),this.stroke(t)),t.draw(!0))},e.prototype.drawPath=function(t){t.drawPoints(this.points)},e.prototype.stroke=function(t){t.setLineWidth(this.lineWidth),t.setStrokeStyle(this.strokeStyle),t.begin(),this.drawPath(t),this.autoClosePath&&t.close(),t.stroke()},e.prototype.applyShadow=function(t){this.shadowColor?t.enableShadow(this.shadowOffsetX,this.shadowOffsetY,this.shadowBlur,this.shadowColor):t.disableShadow()},e.prototype.setLineStyle=function(t){},e.prototype.save=function(e){return this.points.map(function(t){return{x:(t.x-e.x)/e.width,y:(t.y-e.y)/e.height}})},e.prototype.restore=function(i,n){w.each(this.points,function(t,e){t.x=i.x+i.width*n[e].x,t.y=i.y+i.height*n[e].y})},e.prototype.getRect=function(){return function(t){var e=t.length,i=0,n=0,o=0,r=0;if(0<e){var s=t[0];i=o=s.x,n=r=s.y;for(var h=1;h<e;h++)(s=t[h]).x<i?i=s.x:s.x>o&&(o=s.x),s.y<n?n=s.y:s.y>r&&(r=s.y)}return{x:i,y:n,width:o-i,height:r-n}}(this.points)},e.prototype.clone=function(){return new this.constructor(h.copy(this,!0))},e.prototype.toJSON=function(t){var e={number:this.number,lineWidth:this.lineWidth,strokeStyle:this.strokeStyle,fillStyle:this.fillStyle};return this.points&&(e.points=this.points),t&&h.extend(e,t),e},e}();function S(t,e,i,n,o,r){if(e<r&&n<r||r<e&&r<n)return 0;if(n===e)return 0;var s=n<e?1:-1,h=(r-e)/(n-e);return 1!==h&&0!==h||(s=n<e?.5:-.5),o<h*(i-t)+t?s:0}var v=1e-8;function I(t,e){return Math.abs(t-e)<v}function P(t,e){for(var i=[],n=t.length,o=t[n-1].x,r=t[n-1].y,s=0;s<n;s++){var h=t[s],a=h.x,p=h.y,u=(s+1)%n,f=t[u].x,c=t[u].y,l=a-o,y=p-r,d=Math.sqrt(l*l+y*y);y/=d;var E=a-f,S=p-c,v=(l/=d)+(E/=d=Math.sqrt(E*E+S*S)),x=y+(S/=d),_=l*(v/=d=Math.sqrt(v*v+x*x))+y*(x/=d),g=Math.sqrt(1-_*_);w.push(i,{x:a+e*v/g,y:p+e*x/g}),o=a,r=p}return i}function T(t,e,i,n){var o=i-t,r=n-e;return Math.sqrt(o*o+r*r)}function H(t,e,i,n){return{x:Math.floor(t+i*Math.cos(n)),y:Math.floor(e+i*Math.sin(n))}}var m=2*Math.PI,R=function(t){function e(){return _(this,e),d(this,t.apply(this,arguments))}return o(e,t),e.prototype.isPointInFill=function(t,e,i){return function(t,e,i){var n=0,o=t[0];if(!o)return!1;for(var r=1;r<t.length;r++){var s=t[r];n+=S(o.x,o.y,s.x,s.y,e,i),o=s}var h=t[0];return I(o.x,h.x)&&I(o.y,h.y)||(n+=S(o.x,o.y,h.x,h.y,e,i)),0!==n}(this.points,e,i)},e.prototype.drawPath=function(t){t.drawPoints(this.points),t.close()},e.prototype.stroke=function(t){var e=this.points,i=this.strokePosition,n=this.lineWidth,o=this.strokeStyle;n/=A.DEVICE_PIXEL_RATIO,t.setLineWidth(n),t.setStrokeStyle(o),t.begin(),i===A.STROKE_POSITION_INSIDE?e=P(e,n/-2):i===A.STROKE_POSITION_OUTSIDE&&(e=P(e,n/2)),t.drawPoints(e),t.close(),t.stroke()},e.prototype.fill=function(t){t.setFillStyle(this.fillStyle),t.begin(),this.drawPath(t),t.fill()},e.prototype.drawing=function(t,e,i,n,o,r){r();for(var s=this.count,h=T(e,i,n,o),a=m/s,p=[],u=Math.atan2(o-i,n-e),f=u+m;w.push(p,H(e,i,h,u)),(u+=a)<=f;);p.length-s==1&&w.pop(p),this.points=p,this.draw(t)},e.prototype.validate=function(){var t=this.getRect();return 5<t.width&&5<t.height},e.prototype.toJSON=function(){return t.prototype.toJSON.call(this,{name:"Polygon"})},e}(n);var N=Math.PI/180,C=function(t){function e(){return _(this,e),d(this,t.apply(this,arguments))}return o(e,t),e.prototype.drawing=function(t,e,i,n,o,r){r();var s,h=this.thickness,a=T(e,i,n,o),p=20*h;a<p?(h*=a/p,s=a/3):50<(s=a/8)&&(s=50);var u,f,c,l=[],y=this.double,d=.5*s,E=function(t){w.push(l,t),t={x:t.x+a-s,y:t.y},y&&(t.x-=s),w.push(l,t),w.push(l,H(t.x,t.y,d,250*N)),w.push(l,{x:e+a,y:i})};if(y){w.push(l,{x:e,y:i});var S={x:e+s,y:i-h};w.push(l,H(S.x,S.y,d,290*N)),E(S)}else E({x:e,y:i-h});for(var v=l.length-2;0<=v;v--)l.push({x:l[v].x,y:2*i-l[v].y});this.points=(u=e,f=i,c=Math.atan2(o-i,n-e),l.map(function(t){return{x:Math.floor((t.x-u)*Math.cos(c)-(t.y-f)*Math.sin(c)+u),y:Math.floor((t.x-u)*Math.sin(c)+(t.y-f)*Math.cos(c)+f)}})),this.draw(t)},e.prototype.toJSON=function(){return t.prototype.toJSON.call(this,{name:"Polygon"})},e}(R),M=function(t){function e(){return _(this,e),d(this,t.apply(this,arguments))}return o(e,t),e.prototype.setLineStyle=function(t){t.setLineJoin("round"),t.setLineCap("round")},e.prototype.drawing=function(t,e,i,n,o){var r=this.points||(this.points=[{x:e,y:i}]);t.disableShadow(),t.begin(),1===r.length&&(this.setLineStyle(t),t.setLineWidth(this.lineWidth),t.setStrokeStyle(this.strokeStyle)),t.drawPoints(r.slice(r.length-2)),t.lineTo(n,o),t.stroke(),t.draw(!0),w.push(r,{x:n,y:o})},e.prototype.drawPath=function(t){t.drawPoints(this.points)},e.prototype.toJSON=function(){return t.prototype.toJSON.call(this,{name:"Doodle"})},e}(n),b=function(t,e,i){return t+e*(16*Math.pow(Math.sin(i),3))},D=function(t,e,i){return t-e*(13*Math.cos(i)-5*Math.cos(2*i)-2*Math.cos(3*i)-Math.cos(4*i))},L=Math.PI,k=2*L,V=function(t){function e(){return _(this,e),d(this,t.apply(this,arguments))}return o(e,t),e.prototype.drawing=function(t,e,i,n,o,r){r(),this.x=e,this.y=i,this.width=this.height=2*T(e,i,n,o);var s=T(e,0,n,0),h=[],a=s/32,p=L,u=k/Math.max(16*a,30),f=-L;for(w.push(h,{x:b(this.x+s/2,a,p),y:D(this.y,a,p)});w.push(h,{x:b(this.x+s/2,a,p),y:D(this.y,a,p)}),f<=(p-=u););this.points=h,this.draw(t)},e.prototype.validate=function(){return 5<this.width&&5<this.height},e.prototype.toJSON=function(){return t.prototype.toJSON.call(this,{name:"Polygon"})},e}(R),U=function(t){function e(){return _(this,e),d(this,t.apply(this,arguments))}return o(e,t),e.prototype.setLineStyle=function(t){t.setLineCap("square")},e.prototype.drawing=function(t,e,i,n,o,r){r(),(this.points||(this.points=[{x:e,y:i}]))[1]={x:n,y:o},this.draw(t)},e.prototype.validate=function(){var t=this.points;return t&&2===t.length},e.prototype.toJSON=function(){return t.prototype.toJSON.call(this,{name:"Doodle"})},e}(n),W=function(t){function e(){return _(this,e),d(this,t.apply(this,arguments))}return o(e,t),e.prototype.isPointInFill=function(t,e,i){return t.begin(),this.drawPath(t),t.isPointInPath(e,i)},e.prototype.isPointInStroke=function(t,e,i){var n=this.x,o=this.y,r=this.width,s=this.height,h=(this.strokeStyle,this.strokePosition),a=this.lineWidth;a<A.SIZE_MIN&&(a=A.SIZE_MIN);var p=2*a;switch(t.begin(),h){case A.STROKE_POSITION_OUTSIDE:if(t.drawOval(n,o,r+p,s+p),t.isPointInPath(e,i))return t.begin(),t.drawOval(n,o,r,s),!t.isPointInPath(e,i);case A.STROKE_POSITION_CENTER:if(t.drawOval(n,o,r+a,s+a),t.isPointInPath(e,i))return r-=a,s-=a,t.begin(),t.drawOval(n,o,r,s),!t.isPointInPath(e,i);break;case A.STROKE_POSITION_INSIDE:if(t.drawOval(n,o,r,s),t.isPointInPath(e,i))return r-=p,s-=p,t.begin(),t.drawOval(n,o,r,s),!t.isPointInPath(e,i)}return!1},e.prototype.drawPath=function(t){t.drawOval(this.x,this.y,this.width,this.height)},e.prototype.stroke=function(t){var e=this.x,i=this.y,n=this.width,o=this.height,r=this.strokeStyle,s=this.strokePosition,h=this.lineWidth;if(s===A.STROKE_POSITION_INSIDE){if(o-=h,(n-=h)<0||o<0)return}else s===A.STROKE_POSITION_OUTSIDE&&(n+=h,o+=h);t.setLineWidth(h/A.DEVICE_PIXEL_RATIO),t.setStrokeStyle(r),t.begin(),t.drawOval(e,i,n,o),t.stroke()},e.prototype.fill=function(t){t.setFillStyle(this.fillStyle),t.begin(),this.drawPath(t),t.fill()},e.prototype.drawing=function(t,e,i,n,o,r){r(),this.x=e,this.y=i,this.width=this.height=2*T(e,i,n,o),this.draw(t)},e.prototype.save=function(t){return{x:(this.x-t.x)/t.width,y:(this.y-t.y)/t.height,width:this.width/t.width,height:this.height/t.height}},e.prototype.restore=function(t,e){this.x=t.x+t.width*e.x,this.y=t.y+t.height*e.y,this.width=t.width*e.width,this.height=t.height*e.height},e.prototype.validate=function(){return 5<this.width&&5<this.height},e.prototype.getRect=function(){var t=this.x,e=this.y,i=this.width,n=this.height;return{x:t-i/2,y:e-n/2,width:i,height:n}},e.prototype.toJSON=function(){return t.prototype.toJSON.call(this,{name:"Oval",x:this.x,y:this.y,width:this.width,height:this.height})},e}(n);var G,z,F=function(t){function e(){return _(this,e),d(this,t.apply(this,arguments))}return o(e,t),e.prototype.drawing=function(t,e,i,n,o,r){r();var s,h,a,p,u,f,c,l,y=this.points||(this.points=[]),d=(c=(s=e)<(a=n)?a-(u=s):s-(u=a),l=(h=i)<(p=o)?p-(f=h):h-(f=p),{x:u,y:f,width:c,height:l});y[0]={x:d.x,y:d.y},y[1]={x:d.x+d.width,y:d.y},y[2]={x:d.x+d.width,y:d.y+d.height},y[3]={x:d.x,y:d.y+d.height},this.draw(t)},e.prototype.toJSON=function(){return t.prototype.toJSON.call(this,{name:"Polygon"})},e}(R),X=2*Math.PI,J=function(t){function e(){return _(this,e),d(this,t.apply(this,arguments))}return o(e,t),e.prototype.drawing=function(t,e,i,n,o,r){r();var s=this.count,h=this.radius,a=T(e,i,n,o),p=X/s,u=h;u||(u=a/2);for(var f=[],c=Math.atan2(o-i,n-e),l=c+X;w.push(f,H(e,i,a,c)),w.push(f,H(e,i,u,c+p/2)),(c+=p)<=l;);f.length-2*s==2&&w.pop(f),this.points=f,this.draw(t)},e.prototype.validate=function(){var t=this.getRect();return 5<t.width&&5<t.height},e.prototype.toJSON=function(){return t.prototype.toJSON.call(this,{name:"Polygon"})},e}(R),Y="rgba(0,0,0,0)";function K(t){return t+t/6}function Z(t,e){var i=t.fontSize,n=t.fontFamily,o=(t.x,t.y,document.body);(z=document.createElement("p")).style.cssText="\n    position: absolute;\n    visibility: hidden;\n    font: "+i+"px "+n+";\n    line-height: "+K(i)+"px;\n  ",o.appendChild(z);var r=(e+"").split("\n");""===r[r.length-1]&&(r[r.length-1]="W"),z.innerHTML=r.join("<br>");var s=z,h=s.offsetWidth,a=s.offsetHeight;return o.removeChild(z),{width:h+1,height:a}}var j=function(t){function e(){return _(this,e),d(this,t.apply(this,arguments))}return o(e,t),e.prototype.isPointInPath=function(t,e,i){return r(this.getRect(t),e,i)},e.prototype.drawPath=function(t){var e=this.getRect(t);t.drawRect(e.x,e.y,e.width,e.height)},e.prototype.fill=function(i){var n=this.x,o=this.y,t=this.text,r=this.fontSize,e=this.fontFamily,s=this.fontItalic,h=this.fontWeight;i.setFillStyle(this.fillStyle),i.setFont(r,e,s,h);var a=r+r/6;w.each(t.split("\n"),function(t,e){i.fillText(n,o+r+a*e,t)})},e.prototype.stroke=function(i){var n=this.x,o=this.y,t=this.text,r=this.fontSize,e=this.fontFamily,s=this.fontItalic,h=this.fontWeight,a=this.lineWidth,p=this.strokeStyle,u=A.DEVICE_PIXEL_RATIO;i.setLineWidth(a),i.setStrokeStyle(p),i.setFont(r*u,e,s,h);var f=r*u+r*u/6;w.each(t.split("\n"),function(t,e){i.strokeText(n,o+r*u+f*e,t)})},e.prototype.startDrawing=function(t,e,i){return G||(this.x=i.x,this.y=i.y,function(t,e,i,n){var o=n.fontSize,r=n.fontFamily,s=(n.x,n.y,n.fontItalic),h=n.fontWeight,a=n.caretColor,p=n.fillStyle,u=document.body,f=Z(n,"W").height,c=A.DEVICE_PIXEL_RATIO,l=t.getCanvasSize(),y=l.width,d=l.height,E=(y-n.x)/c,S=(d-n.y)/c;G=document.createElement("textarea");var v="\n    position: absolute;\n    left: "+i.pageX+"px;\n    top: "+i.pageY+"px;\n    color: "+Y+";\n    caret-color: "+(a||p)+";\n    background-color: "+Y+";\n    font: "+o+"px "+r+";\n    line-height: "+K(o)+"px;\n    border: 1px dashed "+p+";\n    box-sizing: content-box;\n    outline: none;\n    resize: none;\n    padding: 0;\n    overflow: hidden;\n    width: "+o+"px;\n    height: "+f+"px;\n    max-width: "+E+"px;\n    max-height: "+S+"px;\n    wrap: physical;\n  ";s&&(v+="font-style: italic;"),h&&(v+="font-weight: bold;"),G.style.cssText=v,u.appendChild(G),setTimeout(function(){G.focus()});var x=t.save(),_=!1,g=function(){t.restore(x),n.text=G.value,n.draw(t)},w=function(){var t=Z(n,G.value||"W"),e=t.width,i=t.height;G.style.width=e+"px",G.style.height=i+"px",_||g()},I=function(){_=!0},P=function(){_=!1,g()},T=function(){G.removeEventListener("input",w),G.removeEventListener("compositionstart",I),G.removeEventListener("compositionend",P),G.removeEventListener("blur",T),u.removeChild(G),z=G=null,e.fire(O.SHAPE_DRAWING_END,{shape:n})};G.addEventListener("input",w),G.addEventListener("compositionstart",I),G.addEventListener("compositionend",P),G.addEventListener("blur",T),e.fire(O.SHAPE_DRAWING_START,{cursor:"text"}),e.on(O.ACTIVE_SHAPE_ENTER,function(t){G&&(G.style.height=Z(n,G.value||"W").height+"px")})}(t,e,i,this)),!1},e.prototype.validate=function(){var t=this.text;return t&&t.trim().length},e.prototype.save=function(t){return{x:(this.x-t.x)/t.width,y:(this.y-t.y)/t.height}},e.prototype.restore=function(t,e){this.x=t.x+t.width*e.x,this.y=t.y+t.height*e.y},e.prototype.getRect=function(t){var e=this.x,i=this.y,n=this.text,o=this.fontSize,r=this.fontFamily,s=this.fontItalic,h=this.fontWeight;t.setFont(o*A.DEVICE_PIXEL_RATIO,r,s,h);var a=Z(this,n);return a.x=e,a.y=i,a.width*=A.DEVICE_PIXEL_RATIO,a.height*=A.DEVICE_PIXEL_RATIO,a},e.prototype.toJSON=function(){return t.prototype.toJSON.call(this,{name:"Text",x:this.x,y:this.y,text:this.text,fontSize:this.fontSize,fontFamily:this.fontFamily,fontItalic:this.fontItalic,fontWeight:this.fontWeight})},e}(n),q=function(){function p(t,e,i){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:10;_(this,p);var o=this;o.resize(e,i,!0);var r,s=o.painter=new l(t,e,i),h=o.emitter=new O;o.states=[],o.histories=[{}],o.historyIndex=0,o.maxHistorySize=n;var a=function(){o.refresh()};h.on(O.MOUSE_MOVE,function(e){var i;w.each([o.states,o.getShapes()],function(t){if(w.each(t,function(t){if(t&&!1!==t.isPointInPath(s,e.x,e.y))return i=t,!1},!0),i)return!1}),i!==r&&(r&&h.fire(O.SHAPE_LEAVE,{shape:r}),i&&h.fire(O.SHAPE_ENTER,{shape:i}),r=i)}).on(O.HOVER_SHAPE_CHANGE,a).on(O.ACTIVE_SHAPE_CHANGE,a).on(O.ACTIVE_RECT_CHANGE_END,a).on(O.CLEAR,function(){o.clear()}).on(O.ACTIVE_RECT_CHANGE_START,function(){var t=o.states[0].getShapes();t.length&&o.editShapes(t,null,!0)}).on(O.ACTIVE_SHAPE_DELETE,function(){o.removeActiveShapes()}).on(O.SELECTION_RECT_CHANGE,function(e){o.states[0].setShapes(s,o.getShapes().filter(function(t){if(function(t,e){var i=Math.max(t.x,e.x),n=Math.max(t.y,e.y),o=Math.min(t.x+t.width,e.x+e.width),r=Math.min(t.y+t.height,e.y+e.height);if(0<=o-i&&0<=r-n)return{x:i,y:n,width:o-i,height:r-n}}(t.getRect(s),e.rect))return!0}))}).on(O.SELECTION_START,function(){}).on(O.SELECTION_END,function(){o.refresh()}).on(O.SHAPE_DRAWING_START,function(t){}).on(O.SHAPE_DRAWING,a).on(O.SHAPE_DRAWING_END,function(t){var e=t.shape;if(e){var i={x:0,y:0,width:o.width,height:o.height};e.validate&&!e.validate(s,i)||o.addShape(e,!0),o.refresh()}}).on(O.ACTIVE_DRAG_BOX_HOVER,function(t){var e=t.name;e&&(e+="-resize")})}return p.prototype.resize=function(t,e,i){var n=this.histories,o=this.historyIndex;if(this.width=t,this.height=e,n){var r=n[o];r.shapes&&r.width&&r.height&&s(r.shapes,r.width,r.height,t,e),r.width=t,r.height=e}i||this.refresh()},p.prototype.addShape=function(t,e){this.addShapes([t],e)},p.prototype.addShapes=function(t,e){var i=this.getShapes();this.save(),w.each(t,function(t){w.push(i,t)}),e||this.refresh(),this.emitter.fire(O.SHAPE_ADD,{shapes:t})},p.prototype.removeShape=function(t,e){this.removeShapes([t],e)},p.prototype.removeShapes=function(t,e){this.save();var i={};w.each(t,function(t){i[t.number]=1});var n=[],o=this.getShapes();w.each(o,function(t,e){i[t.number]&&(o.splice(e,1),n.push(t))},!0),e||this.refresh(),this.emitter.fire(O.SHAPE_REMOVE,{shapes:n})},p.prototype.removeActiveShapes=function(){var t=this.states[0];if(t){var e=t.getShapes();e.length&&(this.removeShapes(e,!0),t.setShapes(this.painter,[]))}},p.prototype.editShapes=function(o,r,t){this.save();var s=this.getShapes();w.each(o,function(t,e){var i=s.indexOf(t);if(0<=i){var n=t.clone();r&&h.extend(n,r),s[i]=o[e]=n}}),t||this.refresh(),this.emitter.fire(O.SHAPE_UPDATE,{shapes:o})},p.prototype.getShapes=function(){var t=this.histories[this.historyIndex];return t.shapes||(t.shapes=[])},p.prototype.drawing=function(o){var e=this.states,t=this.emitter,i=this.painter,r=this.config,n=function(t){e[t]&&(e[t].destroy(),e[t]=null)},s=function(t){n(2),e[2]=t};o?(n(0),n(1),s(new c({createShape:function(){var t,e,i,n=new o(r);return n.number=""+(t=10,e=Math.pow(10,t-1),i=Math.pow(10,t)-1,e+Math.floor(Math.random()*(i-e))),n}},t,i))):!1!==o?(e[0]||(e[0]=new u({},t,i)),e[1]||(e[1]=new f(r,t)),s(new a({},t))):(n(0),n(1),s()),this.refresh()},p.prototype.apply=function(t){var e=this.states[0];if(e){var i=e.getShapes();i.length&&this.editShapes(i,t)}this.config=t},p.prototype.refresh=function(){var e=this.painter;e.clear();var t=function(t){t&&t.draw(e)};w.each(this.getShapes(),t),w.each(this.states,t)},p.prototype.clear=function(){this.removeShapes(this.getShapes())},p.prototype.save=function(){var t=this.histories,e=this.maxHistorySize,i=this.historyIndex;t.length>i+1&&t.splice(i+1);var n={width:this.width,height:this.height,shapes:this.getShapes()};0<t.length?t.splice(t.length,0,n):t.push(h.copy(n),n),t.length>e+1&&t.splice(0,1),this.historyIndex=t.length-1},p.prototype.hasPrev=function(){return!!this.histories[this.historyIndex-1]},p.prototype.prev=function(){if(this.hasPrev()){this.historyIndex--,this.emitter.fire(O.RESET);var t=this.histories[this.historyIndex],e=t.width,i=t.height,n=t.shapes;return n&&s(n,e,i,this.width,this.height),!0}},p.prototype.hasNext=function(){return!!this.histories[this.historyIndex+1]},p.prototype.next=function(){if(this.hasNext()){this.historyIndex++,this.emitter.fire(O.RESET);var t=this.histories[this.historyIndex],e=t.width,i=t.height,n=t.shapes;return n&&s(n,e,i,this.width,this.height),this.refresh(),!0}},p.prototype.dispose=function(){this.emitter.dispose()},p}();return q.Emitter=O,q.shapes={Arrow:C,Doodle:M,Heart:V,Line:U,Oval:W,Polygon:R,Rect:F,Star:J,Text:j},q});