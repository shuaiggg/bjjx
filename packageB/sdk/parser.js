var store=require("./store"),util=require("./util");function encode(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}var allowedTag={};function encodeHTML(e){return e.replace(/<?\/?([^\s]+)( [^>]+)?>?/gi,function(e,r){if(util.string.startsWith(e,"<")&&util.string.endsWith(e,">")){var i=r.toLowerCase();allowedTag[i]||(e=encode(e))}else e=encode(e);return e})}function parseBreakline(e){return e.replace(/\n\r?/g,function(){return"<br>"})}function parseWhitespace(e){return e.replace(/ /g,function(e){return"&nbsp;"})}var urlExpr=/(?=http[s]?:\/\/|www)[-~!@#$%^&*_+=.:?\/a-z0-9]+/i;function replaceLink(e){var r=e;return 0!==r.indexOf("http")&&(r=location.protocol+"//"+r),'<em class="bjy-link" data-href="'+r+'">'+e+"</em>"}function parseLink(e,r){return e.replace(urlExpr,r||replaceLink)}function isPureText(e){return!/\[([^\]]+)\]/g.test(e)}var imagePrefix="img:";function parseImage(e,r){var i=/\[([^\]]+)\]/g.exec(e),t=(i[0],i[1]);if(util.string.startsWith(t,imagePrefix))return t=t.substr(imagePrefix.length)}function stringifyImage(e){return"["+imagePrefix+e+"]"}var emojiPrefix="emoji:";function getEmojiUrlByKey(e){var r=key2Emoji[e];if(r)return r.url}function parseEmoji(e,r){var i,t,n=/\[([^\]]+)\]/g.exec(e),a=(n[0],n[1]);if(a.indexOf(":")<0)i=a;else if(util.string.startsWith(a,emojiPrefix)){var s=(a=a.substr(emojiPrefix.length)).indexOf("|");0<=s&&(i=a.substr(0,s),t=a.substr(s+1))}return{name:i,url:t||getEmojiUrlByKey(i)}}function stringifyEmoji(e,r){return r&&(e=emojiPrefix+e+"|"+r),"["+e+"]"}var key2Emoji={};exports.init=function(){var e=store.get("partner.customExpression");util.is.array(e)&&util.array.each(e,function(e,r){key2Emoji[e.key]=e})},exports.parseBreakline=parseBreakline,exports.parseWhitespace=parseWhitespace,exports.parseLink=parseLink,exports.encodeHTML=encodeHTML,exports.isPureText=isPureText,exports.parseEmoji=parseEmoji,exports.stringifyEmoji=stringifyEmoji,exports.getEmojiUrlByKey=getEmojiUrlByKey,exports.parseImage=parseImage,exports.stringifyImage=stringifyImage;